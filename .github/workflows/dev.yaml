name: Dev
on:
  push:
    branches:
      - dev
    paths:
      - docs/**
      - .github/workflows/dev.yaml
      - overrides-dev/**
      - mkdocs.yml
      - dev-robots.txt
      - .htpasswd
      - dev.Dockerfile
      - cloudflare.conf
      - deny.conf
      - dev-nginx.conf
      - dev.toml

jobs:
  site:
    runs-on: ubuntu-latest
    name: Build Documentation
    environment:
      name: Development
      url: https://dev-documentation.breadnet.co.uk

    steps:
      - name: Git Clone
        uses: actions/checkout@v3
      - name: Fly Build and Deploy
        uses: userbradley/actions-fly@v1.0.0
        with:
          flyToken: ${{ secrets.FLY_ACCESS_TOKEN_DEV }}
          configFile: ${{ vars.CONFIG_FILE }}
          dockerfileName: ${{ vars.DOCKERFILE }}

  sarif:
    needs:
      - site
    runs-on: ubuntu-latest
    name: Scan the Docker image
    environment:
      name: Development
      url: https://dev-documentation.breadnet.co.uk
    steps:

      - name: Git Clone
        uses: actions/checkout@v3

      - name: Get docker image name
        uses: userbradley/action-fly-image-getter@dev
        id: getter
        with:
          flyToken: ${{ secrets.FLY_ACCESS_TOKEN_DEV }}
          configFile: ${{ vars.CONFIG_FILE }}

      - name: Login to Fly Registry
        uses: docker/login-action@v2
        with:
          registry: registry.fly.io
          username: x
          password: ${{ secrets.FLY_ACCESS_TOKEN_DEV }}


      - name: Pull image
        run: docker pull ${{ steps.getter.outputs.image }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.getter.outputs.image }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
